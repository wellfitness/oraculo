<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oráculo - Gestión Personal Consciente</title>
  <meta name="description" content="Sistema de gestión personal que te ayuda a priorizar lo importante. Basado en Hábitos Atómicos y filosofía Burkeman.">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Righteous&display=swap" rel="stylesheet">

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css">

  <!-- Favicon & PWA -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#06b6d4">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Oráculo">
</head>
<body>
  <a href="#app-content" class="skip-link">Saltar al contenido principal</a>
  <div class="app-container">
    <!-- Header con navegación -->
    <header class="app-header">
      <a href="#dashboard" data-view="dashboard" class="app-logo">
        <img src="icons/icon-192x192.png" alt="Oráculo" class="logo-img">
        <span class="logo-text">Oráculo</span>
      </a>

      <nav class="app-nav">
        <a href="#dashboard" data-view="dashboard" class="nav-link active" title="Dashboard">
          <span class="nav-icon material-symbols-outlined">home</span>
          <span class="nav-text">Inicio</span>
        </a>
        <a href="#life-wheel" data-view="life-wheel" class="nav-link" title="Rueda de la Vida">
          <span class="nav-icon material-symbols-outlined">donut_large</span>
          <span class="nav-text">Rueda</span>
        </a>
        <a href="#values" data-view="values" class="nav-link" title="Brújula de Valores">
          <span class="nav-icon material-symbols-outlined">explore</span>
          <span class="nav-text">Valores</span>
        </a>
        <a href="#kanban" data-view="kanban" class="nav-link" title="Horizontes">
          <span class="nav-icon material-symbols-outlined">view_kanban</span>
          <span class="nav-text">Horizontes</span>
        </a>
        <a href="#projects" data-view="projects" class="nav-link" title="Proyectos">
          <span class="nav-icon material-symbols-outlined">folder_open</span>
          <span class="nav-text">Proyectos</span>
        </a>
        <a href="#habits" data-view="habits" class="nav-link" title="Laboratorio de Hábitos">
          <span class="nav-icon material-symbols-outlined">science</span>
          <span class="nav-text">Hábitos</span>
        </a>
        <a href="#calendar" data-view="calendar" class="nav-link" title="Calendario">
          <span class="nav-icon material-symbols-outlined">calendar_month</span>
          <span class="nav-text">Calendario</span>
        </a>
        <a href="#journal" data-view="journal" class="nav-link" title="Diario">
          <span class="nav-icon material-symbols-outlined">auto_stories</span>
          <span class="nav-text">Diario</span>
        </a>
        <a href="#achievements" data-view="achievements" class="nav-link" title="Logros">
          <span class="nav-icon material-symbols-outlined">emoji_events</span>
          <span class="nav-text">Logros</span>
        </a>
      </nav>

      <div class="app-actions">
        <a href="#help" data-view="help" class="btn btn--icon" title="Ayuda">
          <span class="material-symbols-outlined">help</span>
        </a>
        <a href="#settings" data-view="settings" class="btn btn--icon" title="Configuración">
          <span class="material-symbols-outlined">settings</span>
        </a>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="app-main" id="app-content">
      <div class="loading">Cargando...</div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <p>
        <strong>Oráculo</strong> — Herramienta de
        <a href="https://movimientofuncional.com" target="_blank" rel="noopener">Movimiento Funcional</a>
      </p>
      <p class="footer-small">
        No puedes hacerlo todo. Y está bien.
      </p>
    </footer>
  </div>

  <!-- Scripts -->
  <script type="module" src="js/app.js"></script>

  <!-- Service Worker Registration -->
  <script>
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

    // Limpiar parámetro de versión SW y mostrar toast de actualización
    (function() {
      const url = new URL(location.href);
      if (url.searchParams.has('_swv')) {
        url.searchParams.delete('_swv');
        history.replaceState(null, '', url.toString());
        // Mostrar toast de actualización
        const toast = document.createElement('div');
        toast.className = 'notification notification--success';
        toast.innerHTML = '<span class="material-symbols-outlined">update</span> App actualizada';
        toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#06b6d4;color:white;padding:12px 24px;border-radius:8px;z-index:9999;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    })();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('SW registrado:', registration.scope);

            // Siempre verificar actualizaciones al cargar
            registration.update();

            // Detectar nueva versión
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  if (isLocalhost) {
                    // En desarrollo: auto-actualizar sin preguntar
                    console.log('[DEV] Nueva versión detectada, actualizando...');
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                  } else {
                    // En producción: mostrar toast
                    showUpdateNotification(registration);
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.log('SW error:', error);
          });
      });

      // Recargar cuando el SW tome control
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });
    }

    function showUpdateNotification(registration) {
      const toast = document.createElement('div');
      toast.className = 'notification notification--update';
      toast.innerHTML = `
        <span>Nueva versión disponible</span>
        <button class="notification__btn" onclick="applyUpdate()">Actualizar</button>
      `;
      document.body.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('notification--visible'));

      window.applyUpdate = () => {
        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        toast.remove();
      };
    }
  </script>
</body>
</html>
